{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Login</title>
    <meta name="csrf-token" content="{{ csrf_token }}" />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-cover bg-center relative min-h-screen"
  style="background-image: url('/static/images/background.jpeg')"
  >
  

    <!-- Login card -->
    <!-- Full-screen flex container to center the login box -->
<div class="relative z-20 flex items-center justify-center min-h-screen">
  <div class="bg-white w-full max-w-md p-6 bg-white bg-opacity-90 shadow-xl rounded-lg">
    <h2 class="text-2xl font-bold mb-4 text-center">Login</h2>
    <form id="login-form" class="space-y-4">
      <div>
        <input
          name="username"
          placeholder="Username"
          class="w-full border px-3 py-2 rounded focus:outline-none focus:border-green-500"
          required
        />
      </div>
      <div>
        <input
          name="password"
          type="password"
          placeholder="Password"
          class="w-full border px-3 py-2 rounded focus:outline-none focus:border-green-500"
          required
        />
      </div>
      <button
        type="submit"
        class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold"
      >
        Login
      </button>
    </form>

    <div class="mt-4 text-center">
      <p class="text-sm text-gray-600">
        New user?
        <a href="/register/" class="text-blue-600 underline hover:text-blue-800">Register here</a>
      </p>
    </div>

    <div id="message" class="mt-4 p-3 rounded hidden">
      <p id="message-text" class="text-sm"></p>
    </div>
  </div>
</div>

    </div>

    <!-- Footer -->
    <footer class="relative z-20 mt-20 text-center text-white text-sm py-4">
      &copy; 2025 PlanMate. All rights reserved.
    </footer>

    <script>
      function getCSRFToken() {
        const tokenMeta = document.querySelector('meta[name="csrf-token"]');
        return tokenMeta ? tokenMeta.getAttribute("content") : "";
      }

      function showMessage(text, isError = false) {
        const messageDiv = document.getElementById("message");
        const messageText = document.getElementById("message-text");
        messageText.textContent = text;
        messageDiv.className = `mt-4 p-3 rounded ${
          isError
            ? "bg-red-50 border border-red-200"
            : "bg-green-50 border border-green-200"
        }`;
        messageDiv.classList.remove("hidden");
      }

      document.getElementById("login-form").onsubmit = async function (e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const body = Object.fromEntries(formData.entries());

        try {
          const res = await fetch("/api/login/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCSRFToken(),
            },
            body: JSON.stringify(body),
          });

          const data = await res.json();

          if (res.ok && data.access && data.refresh) {
            localStorage.setItem("access", data.access);
            localStorage.setItem("refresh", data.refresh);
            showMessage("Login successful! Redirecting...");

            setTimeout(() => {
              if (!data.user.is_email_verified) {
                localStorage.setItem("user_email", data.user.email);
                window.location.href = "/otp/";
              } else if (!data.user.is_profile_completed) {
                window.location.href = "/complete-profile/";
              } else {
                window.location.href = "/profile/";
              }
            }, 1000);
          } else if (res.status === 403 && data.requires_verification) {
            localStorage.setItem("user_email", data.email);
            showMessage("Please verify your email first. Redirecting...");
            setTimeout(() => (window.location.href = "/otp/"), 1500);
          } else {
            showMessage(
              data.detail || "Login failed. Please check your credentials.",
              true
            );
          }
        } catch (error) {
          showMessage(
            "Network error. Please check your connection and try again.",
            true
          );
        }
      };

      window.onload = async () => {
        const token = localStorage.getItem("access");
        if (token) {
          try {
            const meRes = await fetch("/api/profile/", {
              headers: { Authorization: "Bearer " + token },
            });
            if (meRes.ok) {
              const userData = await meRes.json();
              if (!userData.is_email_verified) {
                localStorage.setItem("user_email", userData.email);
                window.location.href = "/otp/";
              } else if (!userData.is_profile_completed) {
                window.location.href = "/complete-profile/";
              } else {
                window.location.href = "/profile/";
              }
            }
          } catch {
            localStorage.removeItem("access");
            localStorage.removeItem("refresh");
          }
        }
      };
    </script>
  </body>
</html>
